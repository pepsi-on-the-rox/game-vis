<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Stats Cards</title>
  <style>
    body {
      background-color: #222;
      color: #eee;
      font-family: Arial, sans-serif;
      margin: 0;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
    }
    svg {
      display: block;
      margin: 0 auto;
    }
    .color-button {
      position: fixed;
      bottom: 20px;
      padding: 10px 24px;
      font-size: 16px;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #blueButton { left: 20px; background:#0055cc; }
    #redButton  { right:20px; background:#cc0000; }
  </style>
</head>
<body>
  <h1 id="pageTitle">Player Stats</h1>
  <div id="cards-container"><p style="text-align:center">Loading data…</p></div>
  <button id="blueButton" class="color-button">Player stats</button>
  <button id="redButton"  class="color-button">Game stats</button>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    function getQueryParams(){
      const p={};
      location.search.slice(1).split('&').forEach(pair=>{
        const[a,b]=pair.split('=');
        if(a)p[a]=decodeURIComponent(b)
      });
      return p
    }
    const params=getQueryParams();
    let selectedPlayers=[];
    if(params.players){
      try{selectedPlayers=JSON.parse(params.players);}
      catch(e){console.error(e);}
    }

    const cardW=220, cardH=320, spacing=240, yStart=80;
    let playerData=[], gameData=[];

    d3.json('datasets/fixed-excali8ur-plays-2025-03-23.json').then(raw=>{
      preprocess(raw);
      render('players');
    }).catch(err=>{
      d3.select('#cards-container').html('<p style="text-align:center">Error loading data.</p>');
      console.error(err);
    });

    function preprocess(data){
      const headers=Object.keys(data[0]||{});
      const nameKeys=headers.filter(k=>/player.*name/i.test(k)&&!/username/i.test(k));
      const winKeys=nameKeys.map(k=>k.replace(/name/i,'win'));
      const gameKey=headers.find(k=>/game name/i.test(k))||headers.find(k=>/play id/i.test(k));

      const pStats={};
      selectedPlayers.forEach(p=>pStats[p]={wins:0, unique:new Set(), rivals:{}});
      data.forEach(rec=>{
        const g=(rec[gameKey]||'').trim();
        nameKeys.forEach((nk,i)=>{
          const name=(rec[nk]||'').trim();
          if(!selectedPlayers.includes(name))return;
          const st=pStats[name];
          if((rec[winKeys[i]]||'').trim()==='1') st.wins++;
          if(g)st.unique.add(g);
          nameKeys.forEach(ok=>{
            const opp=(rec[ok]||'').trim();
            if(opp&&opp!==name){
              st.rivals[opp]=(st.rivals[opp]||0)+1;
            }
          })
        });
      });

      playerData=selectedPlayers.map(p=>{
        const st=pStats[p];
        const rival=Object.entries(st.rivals).sort((a,b)=>b[1]-a[1])[0]||['-',0];
        return {
          type:'player',
          name:p,
          wins:st.wins,
          unique:st.unique.size,
          mostPlayedGame:rival[0],
          rival:`Rival: ${rival[0]} (${rival[1]} games)`
        };
      }).sort((a,b)=>b.wins-a.wins);

      const gCount={}, gPlayers={};
      data.forEach(rec=>{
        const g=(rec[gameKey]||'').trim();
        if(!g)return;
        gCount[g]=(gCount[g]||0)+1;
        gPlayers[g]=gPlayers[g]||new Set();
        nameKeys.forEach(nk=>{
          const n=(rec[nk]||'').trim();
          if(n) gPlayers[g].add(n);
        });
      });

      gameData=Object.entries(gCount).map(([g,c])=>({
        type:'game',
        name:g,
        plays:c,
        unique:gPlayers[g].size
      })).sort((a,b)=>b.plays-a.plays).slice(0,5);
    }

    function render(mode){
      const container=d3.select('#cards-container').html('');
      const dataArr=mode==='players'?playerData:gameData;
      const svgW=Math.max(dataArr.length*spacing+40, window.innerWidth);
      const svgH=500;
      const svg=container.append('svg').attr('width',svgW).attr('height',svgH);
      const startX=(svgW-(dataArr.length-1)*spacing-cardW)/2;

      const cards=svg.selectAll('g.card').data(dataArr, d=>d.name);
      cards.exit().remove();
      const enter=cards.enter().append('g').attr('class','card');
      const merged=enter.merge(cards)
        .attr('transform',(d,i)=>`translate(${startX+i*spacing},${yStart})`);

      merged.selectAll('rect.bg').data(d=>[d]).join(
        enter=>enter.append('rect').attr('class','bg').attr('rx',20).attr('ry',20)
                        .attr('width',cardW).attr('height',cardH)
                        .attr('fill',mode==='players'?'#0055cc':'#cc0000')
                        .attr('stroke','#999').attr('stroke-width',3),
        update=>update.transition().duration(400).attr('fill',mode==='players'?'#0055cc':'#cc0000')
      );

      const topGrp=merged.selectAll('g.top').data(d=>[d]);
      const topEnter=topGrp.enter().append('g').attr('class','top');
      topEnter.append('circle').attr('r',25).attr('cx',25).attr('cy',25).attr('fill','#ccc');
      topEnter.append('text').attr('x',25).attr('y',30)
        .attr('text-anchor','middle').attr('fill','black').style('font-size','16px');
      topGrp.merge(topEnter).select('text').text(d=>mode==='players'?d.wins:`#${dataArr.indexOf(d)+1}`);

      merged.selectAll('rect.img').data(d=>[d]).join(
        enter=>enter.append('rect').attr('class','img').attr('x',15).attr('y',60)
          .attr('width',cardW-30).attr('height',120).attr('fill','#aaa')
      );

      merged.selectAll('rect.nameBar').data(d=>[d]).join(
        enter=>enter.append('rect').attr('class','nameBar')
          .attr('x',15).attr('y',190).attr('width',cardW-30).attr('height',40).attr('rx',8).attr('ry',8).attr('fill','#ddd')
      );

      merged.selectAll('text.nameText').data(d=>[d]).join(
        enter=>enter.append('text').attr('class','nameText').attr('y',215)
          .attr('text-anchor','middle').attr('fill','black').style('font-weight','bold').style('font-size','14px'),
        update=>update
      ).attr('x',cardW/2).text(d=>d.name);

      merged.selectAll('path.descBG').data(d=>[d]).join(
        enter=>enter.append('path').attr('class','descBG')
          .attr('d',`M15,240 h${cardW-30} a10,10 0 0 1 10,10 v50 a10,10 0 0 1 -10,10 h-${cardW-30} a10,10 0 0 1 -10,-10 v-50 a10,10 0 0 1 10,-10`)
          .attr('fill','#bbb')
      );

      merged.selectAll('text.desc').data(d=>[d]).join(
        enter=>enter.append('text').attr('class','desc').attr('text-anchor','middle').attr('fill','black').style('font-size','11px'),
        update=>update
      ).attr('x',cardW/2).attr('y',255).selectAll('tspan').data(d=>{
          if(mode==='players') return d.rival.match(/.{1,28}(?:\\s|$)/g);
          return [`Plays: ${d.plays}`,`Unique: ${d.unique}`];
      }).join(
        enter=>enter.append('tspan'),
        update=>update,
        exit=>exit.remove()
      ).attr('x',cardW/2).attr('dy',(d,i)=>i===0?0:14).text(t=>t.trim());

      const leftGrp=merged.selectAll('g.left').data(d=>[d]);
      const leftEnt=leftGrp.enter().append('g').attr('class','left');
      leftEnt.append('circle').attr('r',25).attr('cx',40).attr('cy',cardH-30).attr('fill','#ccc');
      leftEnt.append('text').attr('x',40).attr('y',cardH-25).attr('text-anchor','middle').attr('fill','black').style('font-size','14px');
      leftGrp.merge(leftEnt).select('text').text(d=>mode==='players'?d.unique:d.plays);

      const rightGrp=merged.selectAll('g.right').data(d=>[d]);
      const rightEnt=rightGrp.enter().append('g').attr('class','right');
      rightEnt.append('circle').attr('r',25).attr('cx',cardW-40).attr('cy',cardH-30).attr('fill','#ccc');
      rightEnt.append('text').attr('text-anchor','middle').attr('fill','black').style('font-size','12px');
      rightGrp.merge(rightEnt).select('text')
        .attr('x',cardW-40).attr('y',cardH-25)
        .text(d=>mode==='players'?d.mostPlayedGame:d.unique);

      d3.select('#pageTitle').text(mode==='players'? 'Player Stats':'Top 5 Games');
    }

    document.getElementById('blueButton').onclick=()=>render('players');
    document.getElementById('redButton').onclick=()=>render('games');
  </script>
</body>
</html>
