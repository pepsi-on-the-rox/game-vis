<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Stats Cards</title>
  <style>
    body {
      background-color: #222;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    .card {
      background-color: #333;
      border: 2px solid #000;
      border-radius: 10px;
      width: 300px;
      margin: 10px auto;
      padding: 15px;
      text-align: left;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.7);
    }
    .card h2 { margin-top: 0; }
    .card p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Player Stats Cards</h1>
  <div id="cards-container">
    <p>Loading player stats...</p>
  </div>
  
  <script>
    // Utility function to parse URL query parameters.
    function getQueryParams() {
      const params = {};
      window.location.search.substring(1).split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if (key) params[key] = decodeURIComponent(value);
      });
      return params;
    }
    
    const params = getQueryParams();
    let selectedPlayers = [];
    if (params.players) {
      try {
        selectedPlayers = JSON.parse(params.players);
      } catch(e) {
        console.error("Error parsing selected players:", e);
      }
    }
    if (selectedPlayers.length === 0) {
      document.getElementById("cards-container").innerHTML = "<p>No player data available.</p>";
      throw new Error("No players selected");
    }
    
    // Fetch the CSV file.
    fetch("datasets/excali8ur-plays-2025-03-23.csv")
      .then(response => {
        if (!response.ok) {
          throw new Error("Network error: " + response.statusText);
        }
        return response.text();
      })
      .then(csvText => {
        // Split CSV text into lines.
        const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
        if (lines.length < 2) throw new Error("CSV doesn't have data rows.");
        const headers = lines[0].split(',').map(h => h.trim());
        console.log("Headers:", headers);
        
        // Determine the index for a unique game identifier (prefer "Game Name", fallback "Play ID").
        let gameNameIndex = headers.findIndex(h => h.toLowerCase().includes("game name"));
        let playIdIndex = headers.findIndex(h => h.toLowerCase().includes("play id"));
        const gameIdIndex = gameNameIndex !== -1 ? gameNameIndex : (playIdIndex !== -1 ? playIdIndex : -1);
        
        // Build an array of name/win pairs.
        const pairs = [];
        headers.forEach((header, idx) => {
          const nameMatch = header.match(/player\s*(\d+)\s*name/i);
          if (nameMatch && !header.toLowerCase().includes("username")) {
            const num = nameMatch[1];
            const winIndex = headers.findIndex(h => h.toLowerCase().includes("player") && 
                                                       h.toLowerCase().includes(num) && 
                                                       h.toLowerCase().includes("win"));
            if (winIndex !== -1) {
              pairs.push({ nameIndex: idx, winIndex: winIndex });
            }
          }
        });
        console.log("Name/Win pairs:", pairs);
        
        // Initialize a stats object for each selected player.
        // For each selected player, we'll track:
        // - matchCount: the total rows (games) they appear in.
        // - wins: the total wins (from the corresponding win columns).
        // - uniqueGames: a Set of game identifiers.
        // - rivalStats: an object that records, for each opponent, the number of games and wins.
        const stats = {};
        selectedPlayers.forEach(player => {
          stats[player] = { matchCount: 0, wins: 0, uniqueGames: new Set(), rivalStats: {} };
        });
        
        // Process each data row.
        for (let i = 1; i < lines.length; i++) {
          const cells = lines[i].split(',').map(cell => cell.trim());
          selectedPlayers.forEach(player => {
            let found = false;
            let winVal = "0";
            const opponentsInRow = new Set();
            pairs.forEach(pair => {
              let nameVal = cells[pair.nameIndex] ? cells[pair.nameIndex].replace(/^"(.*)"$/, '$1').trim() : "";
              let currentWin = cells[pair.winIndex] ? cells[pair.winIndex].replace(/^"(.*)"$/, '$1').trim() : "0";
              if (nameVal.toLowerCase() === player.toLowerCase()) {
                found = true;
                winVal = currentWin;
              } else if (nameVal !== "") {
                opponentsInRow.add(nameVal);
              }
            });
            if (found) {
              stats[player].matchCount++;
              if (winVal === "1") stats[player].wins++;
              if (gameIdIndex !== -1 && cells[gameIdIndex]) {
                let gameId = cells[gameIdIndex].replace(/^"(.*)"$/, '$1').trim();
                stats[player].uniqueGames.add(gameId);
              }
              opponentsInRow.forEach(opp => {
                if (opp.toLowerCase() !== player.toLowerCase()) {
                  if (!stats[player].rivalStats[opp]) {
                    stats[player].rivalStats[opp] = { games: 0, wins: 0 };
                  }
                  stats[player].rivalStats[opp].games++;
                  if (winVal === "1") {
                    stats[player].rivalStats[opp].wins++;
                  }
                }
              });
            }
          });
        }
        
        // Build a stats array for each selected player.
        const statsArray = [];
        selectedPlayers.forEach(player => {
          const s = stats[player];
          const uniqueGameCount = s.uniqueGames.size;
          let biggestRival = null;
          let maxRivalGames = 0;
          let rivalWins = 0;
          for (const opp in s.rivalStats) {
            if (s.rivalStats[opp].games > maxRivalGames) {
              maxRivalGames = s.rivalStats[opp].games;
              biggestRival = opp;
              rivalWins = s.rivalStats[opp].wins;
            }
          }
          let rivalDescription = biggestRival 
            ? `${player}'s biggest rival is ${biggestRival}. Out of ${maxRivalGames} games, ${player} has won ${biggestRival ? ((rivalWins/maxRivalGames)*100).toFixed(1) : 0}% against them.`
            : "No rival data available.";
          
          statsArray.push({
            player: player,
            matchCount: s.matchCount,
            wins: s.wins,
            uniqueGames: uniqueGameCount,
            description: rivalDescription
          });
        });
        console.log("Stats Array:", statsArray);
        
        // Display the stats.
        const container = document.getElementById("cards-container");
        container.innerHTML = "";
        statsArray.forEach(item => {
          container.innerHTML += `
            <div class="card">
              <h2>${item.player}</h2>
              <p><strong>Matches:</strong> ${item.matchCount}</p>
              <p><strong>Wins:</strong> ${item.wins}</p>
              <p><strong>Unique Games:</strong> ${item.uniqueGames}</p>
              <p><strong>Description:</strong> ${item.description}</p>
            </div>
          `;
        });
      })
      .catch(error => {
        console.error("Error processing CSV data:", error);
        document.getElementById("cards-container").innerHTML = "<p>Error loading stats.</p>";
      });
  </script>
</body>
</html>
