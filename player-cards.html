<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Stats Cards</title>
  <style>
    body {
      background-color: #222;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    .card {
      background-color: #333;
      border: 2px solid #000;
      border-radius: 10px;
      width: 300px;
      margin: 10px auto;
      padding: 15px;
      text-align: left;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.7);
    }
    .card h2 { margin-top: 0; }
    .card p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Player Stats Cards</h1>
  <div id="cards-container">
    <p>Loading player stats...</p>
  </div>
  
  <script>
    // Utility: parse URL query params
    function getQueryParams() {
      const params = {};
      window.location.search.substring(1).split('&').forEach(pair => {
        const [key, value] = pair.split('=');
        if (key) params[key] = decodeURIComponent(value);
      });
      return params;
    }
    const params = getQueryParams();
    let selectedPlayers = [];
    if (params.players) {
      try { selectedPlayers = JSON.parse(params.players); } catch(e) { console.error('Parsing error', e); }
    }
    if (selectedPlayers.length === 0) {
      document.getElementById('cards-container').innerHTML = '<p>No player data available.</p>';
      throw new Error('No players selected');
    }

    // Fetch fixed Excalibur JSON
    fetch('datasets/fixed-excali8ur-plays-2025-03-23.json')
      .then(res => { if (!res.ok) throw new Error(res.statusText); return res.json(); })
      .then(data => {
        // Determine keys
        const headers = Object.keys(data[0] || {});
        const nameKeys = headers.filter(k => {
          const lk = k.toLowerCase();
          return lk.includes('player') && lk.includes('name') && !lk.includes('username');
        });
        const winKeys = nameKeys.map(nk => nk.replace(/name/i, 'win'));
        let gameKey = headers.find(k => k.toLowerCase().includes('game name')) ||
                      headers.find(k => k.toLowerCase().includes('play id'));

        // Init stats
        const stats = {};
        selectedPlayers.forEach(p => stats[p] = { matchCount: 0, wins: 0, uniqueGames: new Set(), rivals: {} });

        // Process records
        data.forEach(rec => {
          const gId = gameKey ? (rec[gameKey]||'').trim() : null;
          nameKeys.forEach((nk, i) => {
            const name = (rec[nk]||'').trim();
            if (selectedPlayers.includes(name)) {
              const st = stats[name];
              st.matchCount++;
              const wk = winKeys[i];
              if (wk && (rec[wk]||'').trim() === '1') st.wins++;
              if (gId) st.uniqueGames.add(gId);
              // rivals
              nameKeys.forEach(ok => {
                const opp = (rec[ok]||'').trim();
                if (opp && opp!==name) {
                  st.rivals[opp] = st.rivals[opp]||{games:0,wins:0};
                  st.rivals[opp].games++;
                  if (wk && (rec[wk]||'').trim()==='1') st.rivals[opp].wins++;
                }
              });
            }
          });
        });

        // Build display array
        const statsArr = selectedPlayers.map(p => {
          const s = stats[p];
          const ug = s.uniqueGames.size;
          let br=null, mg=0, bw=0;
          Object.entries(s.rivals).forEach(([opp,val])=>{
            if (val.games>mg) { br=opp; mg=val.games; bw=val.wins; }
          });
          const desc = br ? `Biggest rival: ${br}, played ${mg} times, won ${((bw/mg)*100).toFixed(1)}%` : 'No rival data.';
          return { player:p, matches:s.matchCount, wins:s.wins, uniqueGames:ug, description:desc };
        });

        // Render
        const cont = document.getElementById('cards-container');
        cont.innerHTML = '';
        statsArr.forEach(it => {
          cont.innerHTML += `
            <div class="card">
              <h2>${it.player}</h2>
              <p><strong>Matches:</strong> ${it.matches}</p>
              <p><strong>Wins:</strong> ${it.wins}</p>
              <p><strong>Unique Games:</strong> ${it.uniqueGames}</p>
              <p><strong>${it.description}</strong></p>
            </div>
          `;
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('cards-container').innerHTML = '<p>Error loading stats.</p>';
      });
  </script>
</body>
</html>
