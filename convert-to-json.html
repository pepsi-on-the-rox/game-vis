<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Convert Goldfish CSV to JSON</title>
  <style>
    body {
      background-color: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Goldfish CSV to JSON Converter</h1>
  <button id="convertButton">Convert and Download JSON</button>
  <p id="status">Waiting for action...</p>

  <script>
    function parseCSV(csvText) {
      const rows = [];
      let currentRow = [];
      let currentField = '';
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i + 1];

        if (char === '"' && inQuotes && nextChar === '"') {
          currentField += '"';
          i++; // skip next quote
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          currentRow.push(currentField);
          currentField = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (currentField || currentField === '') {
            currentRow.push(currentField);
            currentField = '';
          }
          if (currentRow.length > 0) {
            rows.push(currentRow);
            currentRow = [];
          }
        } else {
          currentField += char;
        }
      }

      // Push last row if any
      if (currentField || currentRow.length > 0) {
        currentRow.push(currentField);
        rows.push(currentRow);
      }

      return rows;
    }

    function csvToJSON(parsedRows) {
      const headers = parsedRows[0];
      const jsonData = [];
      for (let i = 1; i < parsedRows.length; i++) {
        const row = parsedRows[i];
        if (row.length !== headers.length) continue; // skip malformed
        const obj = {};
        headers.forEach((header, j) => {
          obj[header.trim()] = row[j].trim();
        });
        jsonData.push(obj);
      }
      return jsonData;
    }

    
    document.getElementById("convertButton").addEventListener("click", function() {
      document.getElementById("status").textContent = "Fetching CSV...";
      // Update the fetch URL to the Goldfish CSV file.
      fetch("datasets/excali8ur-plays-2025-03-23.csv")
        .then(response => {
          if (!response.ok) {
            throw new Error("Network error: " + response.statusText);
          }
          return response.text();
        })
        .then(csvText => {
          document.getElementById("status").textContent = "Parsing CSV...";

          // Parse CSV into rows with proper handling of quoted fields
          const parsedRows = parseCSV(csvText);

          // Convert parsed rows to JSON
          const jsonData = csvToJSON(parsedRows);
          // Stringify JSON data with indentation.
          const jsonString = JSON.stringify(jsonData, null, 2);
          
          // Create a Blob for the JSON data.
          const blob = new Blob([jsonString], { type: "application/json" });
          // Create a URL for the Blob.
          const url = URL.createObjectURL(blob);
          
          // Display a temporary download link.
          const a = document.createElement("a");
          a.href = url;
          a.download = "fixed-excali8ur-plays-2025-03-23.json";
          document.body.appendChild(a);
          a.click();
          // Clean up.
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          document.getElementById("status").textContent = "Conversion complete. JSON file downloaded.";
        })
        .catch(error => {
          console.error("Error:", error);
          document.getElementById("status").textContent = "Error: " + error.message;
        });
    });
  </script>
</body>
</html>
